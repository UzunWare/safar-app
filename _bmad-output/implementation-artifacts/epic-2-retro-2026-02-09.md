# Epic 2 Retrospective: Onboarding & Learning Pathway

**Date:** 2026-02-09
**Facilitator:** Bob (Scrum Master)
**Epic:** Epic 2 - Onboarding & Learning Pathway
**Status:** Complete (4/4 stories done)
**Model:** Claude Opus 4.6

## Team Participants

- Alice (Product Owner)
- Bob (Scrum Master) - Facilitator
- Charlie (Senior Dev)
- Dana (QA Engineer)
- Elena (Junior Dev)
- Emrek (Project Lead)

## Epic Summary

### Delivery Metrics

- **Stories Completed:** 4/4 (100%)
- **Implementation Period:** Feb 5 - Feb 9, 2026
- **Test Suite Growth:** 0 tests (start) -> 56 tests (end), 6 test suites
- **FRs Covered:** FR9 (script assessment), FR10 (pathway view), FR11 (begin pathway), FR12 (onboarding tracking)

### Quality Metrics

- **Code Reviews Performed:** 5 (Story 2-3 received two reviews)
- **Total Issues Found:** ~36 (1 CRITICAL, 8 HIGH, 16 MEDIUM, 11 LOW)
- **Issues Fixed:** ~30 (all CRITICAL, HIGH, and MEDIUM resolved)
- **Test Coverage:** 56 unit/component tests, all mocked (no integration tests)

### Stories Delivered

| Story | Title | Agent | Tests Added | Review Issues |
|-------|-------|-------|-------------|---------------|
| 2-1 | Onboarding Flow & Script Assessment | Sonnet 4.5 | 0 (no test infra) | 12 (1C, 3H, 4M, 4L) |
| 2-2 | Pathway Introduction & Selection | Opus 4.6 | 19 | 5 (review fixes) |
| 2-3 | Database Schema for Learning Content | Opus 4.6 | 15 | 16 (two reviews: 9 + 7) |
| 2-4 | Onboarding Completion Tracking | Sonnet 4.5 | 22 | 8 (2H, 4M, 2L) |

## Successes

### 1. 100% Story Completion
All four stories delivered and reviewed, covering FR9-FR12 completely. The onboarding funnel is fully functional: welcome -> script assessment -> pathway introduction -> completion tracking with navigation guard.

### 2. Test Infrastructure Established
Story 2-2 discovered and resolved the Expo SDK 54 Jest compatibility issue (`expo/src/winter/runtime.native.ts` lazy requires fail in Jest). The custom `ExpoTestEnvironment` that locks globals as non-configurable before jest-expo setup runs became the foundation for all subsequent testing. Test count grew progressively: 0 -> 19 -> 34 -> 56.

### 3. Adversarial Code Review Process
Every story underwent adversarial review, catching ~36 issues total. Most impactful finds:
- **CRITICAL (Story 2-1):** Missing database migration error handling - users would crash on missing columns
- **HIGH (Story 2-4):** Offline cache written but never read - the AsyncStorage fallback was completely broken on session restore
- **HIGH (Story 2-4):** Local `UserProfileUpdate` type masked null mismatch via `as` assertions

### 4. Clean Database Schema
Story 2-3 produced 6 migration files with proper RLS policies (anon + authenticated), UNIQUE ordering constraints, idempotent seed data, and self-contained `handle_updated_at()` function. TEXT primary keys match existing codebase patterns.

### 5. Analytics Foundation
Story 2-1's code review added `lib/utils/analytics.ts` with `trackEvent()` wrapper and onboarding funnel events: `onboarding_welcome_viewed`, `script_assessment_completed`, `onboarding_completed`. Ready for Mixpanel integration.

## Challenges

### 1. Story 2-1 Shipped Without Tests
The first story had no test framework available. Dev noted "Project does not have test framework (Jest/RTL) configured. Test infrastructure setup recommended as separate story." This meant 12 code review issues were the only quality gate.

### 2. Type Safety Shortcuts (3/4 Stories)
Type assertions appeared repeatedly:
- **Story 2-1:** `as any` assertions in progress API
- **Story 2-3:** Duplicate conflicting type exports in `types/index.ts`
- **Story 2-4:** `as UserProfileUpdate` assertions hiding null/undefined mismatches

Each instance masked real bugs that were only caught during code review.

### 3. Inconsistent Offline-First Implementation (3/4 Stories)
- **Story 2-1:** Initially used SecureStore for preferences (architecture says AsyncStorage)
- **Story 2-1:** `completeOnboarding()` function had to be ADDED during code review
- **Story 2-4:** Offline cache was written but never read on session restore

The architecture doc specifies the offline-first pattern clearly, but implementations diverged.

### 4. Debug Code in Production
Story 2-4 shipped with two `console.log` statements in the navigation guard (`_layout.tsx`). Caught in code review but shouldn't have been there.

### 5. No Deployed Supabase Project
All TypeScript types in `supabase.types.ts` are manually maintained. No real database exists to validate queries against. This creates drift risk for Epic 3.

## Key Insights

### 1. Code Review Catches What Tests Miss
The adversarial code review process found architectural violations (wrong storage API), logic bugs (cache never read), and type safety issues that mocked tests cannot detect. The two-review pass on Story 2-3 found different issues each time, confirming that fresh eyes matter.

### 2. First Story Carries Infrastructure Burden
Story 2-1 had to establish patterns (analytics, colors, accessibility) without test infrastructure. Story 2-2 then spent significant effort setting up Jest, creating the custom test environment, and establishing mock patterns. This is expected for the first epic after project initialization but should be accounted for.

### 3. Architecture Compliance Needs Active Enforcement
Having patterns documented in `architecture.md` is necessary but insufficient. Implementations diverged from architecture decisions (SecureStore vs AsyncStorage, offline pattern) despite clear documentation. Enforcement needs to happen at code review time with explicit architecture-compliance checks.

### 4. Progressive Quality Improvement
The epic showed clear improvement trajectory:
- Story 2-1: 0 tests, 12 review issues
- Story 2-2: 19 tests, 5 review fixes, test infra established
- Story 2-3: 15 tests, 16 review issues across two reviews, schema solid
- Story 2-4: 22 tests, 8 review issues, all addressed

By the end, the team was writing better code, catching more issues in tests, and code reviews were finding fewer but deeper issues.

## Previous Retrospective Follow-Through

N/A - This is the first retrospective for the project.

## Next Epic Preview: Epic 3 - Core Learning Experience

### Dependencies on Epic 2
- `usePathway` hook from Story 2-2 (pathway/unit data fetching)
- Database schema from Story 2-3 (pathways, units, lessons, words, roots, word_roots tables)
- Navigation guard from Story 2-4 (onboarding bypass)
- Auth store and Supabase client from Epic 1

### Significant Discovery: Schema Already Exists
Epics.md lists "Create words table migration" under Story 3-2's technical notes, but Story 2-3 already built all 6 content table migrations. The create-story workflow must account for this when creating Story 3-2's detailed file. This is NOT a fundamental change - the stories just need adjusted technical notes.

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|-----------------|
| 1 | Enforce "tests required" in definition of done | Bob (SM) | Every Story 3-x file includes test requirements in AC |
| 2 | Ban type assertions (`as Type`, `as any`) in new code | Charlie (Dev) | Zero `as` assertions in Epic 3 code |
| 3 | No console.log in production code | Charlie (Dev) | `console.log` grep returns zero in app/ code |

### Technical Debt

| # | Item | Owner | Priority |
|---|------|-------|----------|
| 1 | Story 2-1 has zero test coverage | Dana (QA) | Medium |
| 2 | Manually maintained TypeScript types (not from live schema) | Charlie (Dev) | High |
| 3 | Story numbering mismatch (epics.md 2.3 vs implementation 2-4) | Bob (SM) | Low |

### Team Agreements

- Every story gets adversarial code review before marking "done"
- Offline-first pattern: always read AND write AsyncStorage cache
- Architecture doc is authoritative for storage decisions (SecureStore = auth tokens ONLY)

## Epic 3 Preparation Tasks

### Critical (Before Epic Starts)

| Task | Owner | Notes |
|------|-------|-------|
| Deploy Supabase project, run migrations + seed | Charlie | Blocks Story 3-2 |
| Generate `supabase.types.ts` from live schema | Charlie | Replace manually maintained types |
| Expand seed data - full Al-Fatiha (~20 words) | Charlie | Only 8 words currently seeded |

### Parallel (During Early Stories)

| Task | Owner | Notes |
|------|-------|-------|
| Verify Arabic font (Amiri) renders with tashkeel | Elena | Needed for Story 3-2 |
| Source audio files for word pronunciation | Alice | Placeholder URLs exist in schema |

### Nice-to-Have

| Task | Owner | Notes |
|------|-------|-------|
| Integration test against real Supabase | Dana | Currently all tests are mocked |
| Research react-native-reanimated spring animations | Elena | Needed for Story 3-3 |

## Critical Path

1. **Deploy Supabase + expand seed data** -> Must complete before Story 3-2
2. **Story 3-1 can start immediately** - uses existing `usePathway` hook, no new data needed

## Readiness Assessment

| Area | Status | Notes |
|------|--------|-------|
| Testing & Quality | Pass | 56/56 tests passing, all HIGH issues fixed |
| Deployment | Not deployed | No Supabase project - critical prep item |
| Technical Health | Good | Clean after code reviews, patterns established |
| Unresolved Blockers | None blocking | Numbering mismatch is cosmetic |

## Commitments Summary

- **Action Items:** 6
- **Preparation Tasks:** 7 (3 critical, 2 parallel, 2 nice-to-have)
- **Critical Path Items:** 2

## Next Steps

1. Deploy Supabase project and run all migrations
2. Expand seed data for full Al-Fatiha coverage
3. Begin Story 3-1 (Pathway & Unit Navigation) immediately
4. Review action items in next standup
5. Start creating Story 3-1 detailed file via SM agent's create-story workflow
