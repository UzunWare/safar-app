# Epic 4 Retrospective: Knowledge Assessment & Spaced Repetition

**Date:** 2026-02-13
**Facilitator:** Bob (Scrum Master)
**Participants:** Bob (SM), Alice (PO), Charlie (Senior Dev), Dana (QA), Elena (Junior Dev), Emrek (Project Lead)

---

## Epic Summary

| Metric | Value |
|--------|-------|
| Stories Completed | 6/6 (100%) |
| Test Suite Growth | 245 → 529 (+284 new tests) |
| Code Review Issues | ~51 total across 6 stories |
| Production Incidents | 0 |
| Agent Models | Claude Opus 4.6 (4.1-4.5), Claude Sonnet 4.5 (4.6) |

### Stories Delivered

| Story | Title | Tests Added | Review Issues |
|-------|-------|-------------|---------------|
| 4-1 | Multiple Choice Quiz | 54 (4 in review) | 3H, 4M, 2L |
| 4-2 | Quiz Completion & Results | 35 | 3H, 5M, 2L |
| 4-3 | Difficulty Rating (4-Button) | 48 (1 in review) | 2H, 2M, 3L |
| 4-4 | SM-2 Spaced Repetition Algorithm | 24 (+7 in review) | 3H, 4M, 2L |
| 4-5 | Review Queue | 23 (+2 in review) | 2C, 1H, 4M, 2L |
| 4-6 | Word Learning States | 52 | 4H, 3M |

---

## Previous Retrospective Follow-Through (Epic 3)

### Action Items

| # | Commitment | Status | Evidence |
|---|-----------|--------|----------|
| 1 | Interactive verification — every Pressable must have working onPress handler | ✅ Completed | Zero unwired handler findings across all 6 Epic 4 stories. CRITICAL issues in 4.5 were navigation route registration, not unwired handlers. |
| 2 | Task checkboxes = post-implementation verification, not aspiration | ✅ Completed | Story 4.4 honestly documented "Tasks 1-6 validated as already implemented by Story 4-3" rather than falsely claiming implementation. No inaccurate checkbox findings. |
| 3 | Address at least 1 tech debt item from Epic 2 | ❌ Not addressed | Story 2-1 still has zero tests. Manual TypeScript types grew further (user_word_progress added). Story numbering mismatch persists. |

### Technical Debt Status (from Epic 3 retro)

| # | Item | Status | Impact |
|---|------|--------|--------|
| 1 | Story 2-1 zero test coverage | ❌ Not addressed | Medium — onboarding screens untested (3 epics deferred) |
| 2 | Manually maintained TypeScript types | ❌ Not addressed | High — now spans 12+ tables, growing every epic |
| 3 | Story numbering mismatch | ❌ Not addressed | Low — cosmetic only |
| 4 | ProgressDot hardcoded hex colors | ❌ Not addressed | Low |
| 5 | user_lesson_progress missing updated_at trigger | ❌ Not addressed | Low |
| 6 | Test mock chain duplicated in learn.test.tsx | ❌ Not addressed | Low |

### Assessment

2 of 3 process improvements were completed — notably, the "interactive verification" commitment eliminated Epic 3's worst pattern (unwired handlers). However, 0 of 6 tech debt items were addressed for the third consecutive epic. The tech debt continues to compound, particularly manual TypeScript types which now span 12+ tables.

---

## Successes & Strengths

### 1. Complete Assessment & Spaced Repetition Pipeline
The full learning feedback loop is now operational: quiz after lesson → score & results → word progress initialization → difficulty rating → SM-2 scheduling → review queue → learning state tracking. This is the retention engine that makes vocabulary stick.

### 2. SM-2 Algorithm Correct on First Pass
Story 4.3's SM-2 implementation passed all 23 tests on the first run. The quality-to-SM2 mapping (0-3 → 2-5), ease factor adjustment formula, and interval calculations were all correct immediately. This demonstrates strong algorithmic understanding from the architecture spec.

### 3. Local-First Architecture Excellence
Story 4.4 delivered `wordProgressLocal.ts` with proper offline storage + sync following the existing `progress.ts` pattern. The `useWordProgress` hook uses Supabase-first + AsyncStorage fallback for reads, and saves locally first with fire-and-forget Supabase sync for writes. The UI never blocks on network latency.

### 4. Derived State Over New Tables (Again)
Story 4.6 continued Epic 3's successful pattern — learning states (new/learning/review/mastered) are derived from existing SM-2 fields (repetitions + interval) rather than adding new database columns. This eliminates sync issues and keeps the schema lean.

### 5. Massive Test Growth (+284 Tests)
Test suite grew from 245 to 529 tests — a 116% increase. Average of 47 new tests per story. SM-2 algorithm has particularly thorough coverage (23 unit tests for the core function). The testing commitment from Epic 2 continues to be honored.

### 6. Unwired Handler Pattern Eliminated
Epic 3's most dangerous bug pattern — buttons that render correctly but have no handler — did not appear in any Epic 4 story. The "interactive verification" code review checklist item from Epic 3's retro worked.

### 7. Divine Geometry Design Consistency
All quiz, rating, review, and state indicator components use the emerald/gold/cream/midnight palette. Story 4.3 used garnet/amber/gold/teal for difficulty buttons (matching prototype), and Story 4.6's code review enforced centralized color imports from `constants/colors.ts`.

---

## Challenges & Growth Areas

### 1. Navigation Route Registration — New Systemic Gap (3/6 Stories)
The most significant pattern in Epic 4. New screens are created but not properly registered in the navigation system:
- **Story 4.1 (HIGH):** `RootStackParamList` missing quiz route type
- **Story 4.5 (CRITICAL x2):** Root layout redirect guard blocked `/review/session` — the entire review session was **completely inaccessible**. Plus missing `Stack.Screen` registration.

**Root Cause:** Expo Router's file-based routing creates the screen automatically, but the app has additional navigation infrastructure (type definitions, redirect guards, Stack.Screen registrations) that must be manually updated. Developers create the screen file but forget the supporting registration.

**Impact:** Story 4.5's CRITICAL issues meant users pressing "Start Review" would be silently redirected back — the core review feature was broken until code review caught it.

### 2. SM-2 Algorithm Subtlety Bugs (2/6 Stories)
- **Story 4.3 (HIGH):** EF calculation order was wrong — interval used the new EF before updating, but SM-2 spec requires using the current EF for interval calculation first, then updating EF. Subtle but mathematically significant.
- **Story 4.4 (HIGH):** `.single()` instead of `.maybeSingle()` made the local fallback unreachable for new words that don't have a Supabase record yet.

**Root Cause:** SM-2 algorithm has specific mathematical ordering requirements that aren't intuitive. The spec was followed but the operation order was wrong.

### 3. Story Scope Overlap (Stories 4.3 ↔ 4.4)
Story 4.4 (SM-2 Algorithm) discovered that Tasks 1-6 were already implemented by Story 4.3 (Difficulty Rating). Only Tasks 7-8 (local-first storage + hook) were genuinely new work. This represents a planning gap — the SM-2 algorithm was naturally implemented as part of the difficulty rating component.

**Root Cause:** Epic planning didn't account for the natural coupling between "implement the rating UI" and "implement the algorithm the UI calls." The algorithm was a dependency of the rating component, not a separate deliverable.

### 4. Incomplete Error Handling (Story 4.2)
- Word progress results not checked — failures silently ignored
- Completion failure navigated silently instead of showing Alert with Retry/Go Back
- Analytics sent count instead of full flagged_word_ids array

**Root Cause:** Happy path was thoroughly implemented, but error paths were afterthoughts.

### 5. Tech Debt Compounding (3 Epics Deferred)
All 6 tech debt items from Epic 3 retro remain unaddressed. Manual TypeScript types now span 12+ tables and grow with every epic. The team has committed to addressing tech debt in 3 consecutive retros without follow-through.

---

## Key Insights & Learnings

1. **Navigation registration is the new "unwired handlers"** — Just as Epic 3 had buttons without handlers, Epic 4 had screens without route registration. The pattern is: developers create the visible artifact but miss the supporting infrastructure. Code review must explicitly check route guards, Stack.Screen registration, and navigation type definitions for every new screen.

2. **Algorithm correctness needs specification-level review** — SM-2 bugs weren't logic errors but ordering/API mismatches. Reviews should cross-reference the algorithm spec, not just verify the code compiles and passes basic tests.

3. **Coupled stories should be combined** — Stories 4.3 and 4.4 were essentially one story. When a UI component requires a new algorithm, the algorithm should be part of the same story, not a separate deliverable. This avoids scope overlap and reduces planning overhead.

4. **Local-first is a reusable pattern** — `wordProgressLocal.ts` follows the same pattern as `progress.ts`. This could be extracted into a generic `createLocalFirstStorage()` utility to reduce boilerplate in future offline-capable features.

5. **Process improvements compound positively** — Epic 2's "tests required" commitment led to 189 tests in Epic 3, which led to 284 tests in Epic 4. Epic 3's "interactive verification" commitment eliminated unwired handlers in Epic 4. Sustained process investment pays off.

6. **Tech debt commitments need accountability mechanisms** — Three consecutive retros have committed to addressing tech debt without follow-through. The commitment is clearly not sufficient — it needs a forcing function (e.g., first story of next epic must be a tech debt story).

---

## Action Items

### Process Improvements

| # | Action | Owner | Success Criteria |
|---|--------|-------|------------------|
| 1 | Add "navigation registration checklist" to code review — verify route guards, Stack.Screen, type definitions for every new screen | Bob (SM) | Zero navigation registration issues in Epic 5 reviews |
| 2 | Algorithm implementations must include spec reference and cross-reference review | Charlie (Senior Dev) | SM-2 and any new algorithm changes are verified against spec document |
| 3 | Combine tightly coupled stories during planning — if UI requires new algorithm, keep them together | Alice (PO) | No story scope overlap in Epic 5 |

### Technical Debt (Cumulative — Prioritized)

| # | Item | Priority | Source | Age |
|---|------|----------|--------|-----|
| 1 | Manually maintained TypeScript types (12+ tables) | **HIGH** | Epic 2 (growing every epic) | 3 epics |
| 2 | Story 2-1 zero test coverage | Medium | Epic 2 | 3 epics |
| 3 | Parallel quiz type systems (QuizQuestion vs QuizQuestionData) | Medium | Epic 4 (Story 4.1 L2) | New |
| 4 | No offline fallback for wordProgress.ts upsert | Medium | Epic 4 (Story 4.2 M5) | New |
| 5 | Story numbering mismatch | Low | Epic 2 | 3 epics |
| 6 | ProgressDot hardcoded hex colors | Low | Epic 3 | 1 epic |
| 7 | user_lesson_progress missing updated_at trigger | Low | Epic 3 | 1 epic |
| 8 | Test mock chain duplicated in learn.test.tsx | Low | Epic 3 | 1 epic |
| 9 | Placeholder celebration.json Lottie animation | Low | Epic 4 (Story 4.2 M4) | New |
| 10 | WordCard showLearningState prop not integrated into lesson/vocab screens | Low | Epic 4 (Story 4.6 M) | New |

### Team Agreements (Carried Forward + New)

**From Epic 2 (Continued):**
- Every story gets adversarial code review before "done"
- Offline-first: always read AND write AsyncStorage cache
- Architecture doc is authoritative for storage decisions

**From Epic 3 (Continued):**
- Interactive elements must be verified by clicking/tapping during review
- Task checkboxes = post-implementation verification, not aspiration
- All animations must support Reduce Motion system setting

**New from Epic 4:**
- Every new screen must have verified route guard inclusion, Stack.Screen registration, and navigation type definition
- Algorithm implementations must reference the specification document in code comments
- Error paths must be implemented alongside happy paths, not deferred

---

## Next Epic Preview: Epic 5 — Progress Tracking & Engagement

### Stories Planned
1. **5-1**: Progress Dashboard
2. **5-2**: Streak Tracking
3. **5-3**: Streak Freeze
4. **5-4**: XP Points System
5. **5-5**: Push Notifications — Streak Reminders
6. **5-6**: Push Notifications — Review Reminders

### Dependencies on Epic 4 (All Complete)
- [x] user_word_progress table + SM-2 algorithm (mastered count for dashboard)
- [x] Word learning states (new/learning/review/mastered for progress display)
- [x] useMasteredCount hook (North Star metric)
- [x] Review queue hook (for review reminder notifications)
- [x] Quiz completion + lesson tracking (for streak activity detection)

### New Technical Requirements
- Expo Notifications setup (push notification permissions, scheduling)
- SVG-based ProgressRing component (circular progress visualization)
- user_streaks table migration (current_streak, longest_streak, last_activity_date, freeze_used_at)
- user_xp table migration (total_xp, updated_at)
- Deep linking from notifications to specific screens

### Readiness Assessment
- **Testing & Quality:** Strong — 529 tests passing, adversarial reviews catching CRITICALs
- **Technical Health:** Good — local-first architecture solid, SM-2 algorithm verified
- **Dependencies:** All met — Epic 5 can start immediately
- **Significant Discoveries:** None — Epic 5 plan remains valid as-is

**Epic Update Required: NO** — Epic 5 can proceed as planned.

---

## Preparation Tasks for Epic 5

No blocking preparation needed. Key infrastructure from Epic 4:
- [x] SM-2 algorithm with local-first storage
- [x] Review queue with due word queries
- [x] Word learning states (derived from SM-2 fields)
- [x] user_word_progress table with RLS policies
- [x] DifficultyRating component (reusable in review sessions)
- [x] Quiz → Results → Completion pipeline

**Recommended parallel tasks during early Epic 5 stories:**
- [ ] Research Expo Notifications setup and permission flows
- [ ] Design ProgressRing SVG component (reference prototype.jsx)
- [ ] Plan streak tracking timezone handling (device local time)

**Ready to begin Epic 5 immediately.**

---

## Retrospective Closure

**Key Takeaways:**
1. Navigation route registration is the new systemic gap — screens get created but not registered
2. Algorithm correctness requires spec-level review, not just test passing
3. Process improvements compound — "tests required" and "interactive verification" both paid off
4. Tech debt needs a forcing function, not just commitment — 3 epics of deferral proves this

**Commitments:** 3 process improvements, 10 tracked tech debt items, 9 team agreements (6 carried + 3 new)

Epic 4 delivered the complete assessment and spaced repetition pipeline — from quiz to SM-2 scheduling to review sessions to learning state tracking — with 284 new tests, local-first architecture, and zero production incidents. The navigation registration pattern is the key area for improvement heading into Epic 5.
